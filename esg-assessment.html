// ESG ë³´ì•ˆ ì§„ë‹¨ ì‹œìŠ¤í…œ - Google Apps Script ì›¹ì•±
// ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš” (URLì—ì„œ ì¶”ì¶œ)
const SPREADSHEET_ID = '1SrVBB7c34TbRj_mQj8ondde9oGg2ufKtByH1HtCbKYI'; // ì‹¤ì œ IDë¡œ ë³€ê²½ í•„ìš”

function doPost(e) {
  try {
    console.log('ğŸ“¥ POST ìš”ì²­ ë°›ìŒ');
    
    // POST ë°ì´í„° í™•ì¸
    if (!e || !e.postData || !e.postData.contents) {
      console.log('âŒ POST ë°ì´í„° ì—†ìŒ');
      return ContentService
        .createTextOutput(JSON.stringify({
          success: false,
          message: 'POST ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    console.log('ğŸ“‹ POST ë°ì´í„° ìˆ˜ì‹ :', e.postData.contents);
    
    // ìš”ì²­ ë°ì´í„° íŒŒì‹±
    const data = JSON.parse(e.postData.contents);
    console.log('ğŸ” íŒŒì‹±ëœ ë°ì´í„°:', data);
    
    // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
    if (!data.companyName || !data.email || !data.companySize || !data.businessType) {
      console.log('âŒ í•„ìˆ˜ ì •ë³´ ëˆ„ë½:', {
        companyName: !!data.companyName,
        email: !!data.email, 
        companySize: !!data.companySize,
        businessType: !!data.businessType
      });
      return ContentService
        .createTextOutput(JSON.stringify({
          success: false,
          message: 'í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.'
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    console.log('ğŸ”— ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ê²° ì‹œë„:', SPREADSHEET_ID);
    
    // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ë°ì´í„° ì €ì¥
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getActiveSheet();
    console.log('âœ… ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ê²° ì„±ê³µ, ì‹œíŠ¸ëª…:', sheet.getName());
    
    const timestamp = new Date().toISOString();
    
    const rowData = [
      timestamp,
      data.companyName,
      data.companySize,
      data.businessType,
      data.email,
      data.overallScore || 0,
      data.maturityLevel || 1,
      data.identityScore || 0,
      data.deviceScore || 0,
      data.networkScore || 0,
      data.systemScore || 0,
      data.applicationScore || 0,
      data.dataScore || 0,
      JSON.stringify(data.allAnswers || {})
    ];
    
    console.log('ğŸ“ ì €ì¥í•  ë°ì´í„°:', rowData);
    
    // ìƒˆ í–‰ ì¶”ê°€
    sheet.appendRow(rowData);
    console.log('âœ… ë°ì´í„° ì €ì¥ ì™„ë£Œ');
    
    // ì„±ê³µ ì‘ë‹µ
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        message: 'ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
        timestamp: timestamp,
        rowsAdded: 1
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    // ì—ëŸ¬ ì‘ë‹µ
    console.error('âŒ ì˜¤ë¥˜ ë°œìƒ:', error);
    console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        message: 'ì„œë²„ ì˜¤ë¥˜: ' + error.toString(),
        error: error.name || 'Unknown Error',
        stack: error.stack
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  // GET ìš”ì²­ ì²˜ë¦¬ (API ìƒíƒœ í™•ì¸ìš©)
  const testData = {
    message: 'ESG ë³´ì•ˆ ì§„ë‹¨ ì‹œìŠ¤í…œ APIê°€ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤.',
    timestamp: new Date().toISOString(),
    spreadsheetId: SPREADSHEET_ID.substring(0, 10) + '...', // ID ì¼ë¶€ë§Œ í‘œì‹œ
    status: 'OK'
  };
  
  return ContentService
    .createTextOutput(JSON.stringify(testData))
    .setMimeType(ContentService.MimeType.JSON);
}

// í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ (ìˆ˜ë™ ì‹¤í–‰ìš©)
function testFunction() {
  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getActiveSheet();
    console.log('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ê²° ì„±ê³µ');
    console.log('ì‹œíŠ¸ ì´ë¦„:', sheet.getName());
    return 'í…ŒìŠ¤íŠ¸ ì„±ê³µ';
  } catch (error) {
    console.error('í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
    return 'í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.toString();
  }
}
