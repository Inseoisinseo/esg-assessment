// ESG 보안 진단 시스템 - Google Apps Script 웹앱
// 스프레드시트 ID를 여기에 입력하세요 (URL에서 추출)
const SPREADSHEET_ID = '1SrVBB7c34TbRj_mQj8ondde9oGg2ufKtByH1HtCbKYI'; // 실제 ID로 변경 필요

function doPost(e) {
  try {
    console.log('📥 POST 요청 받음');
    
    // POST 데이터 확인
    if (!e || !e.postData || !e.postData.contents) {
      console.log('❌ POST 데이터 없음');
      return ContentService
        .createTextOutput(JSON.stringify({
          success: false,
          message: 'POST 데이터가 없습니다.'
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    console.log('📋 POST 데이터 수신:', e.postData.contents);
    
    // 요청 데이터 파싱
    const data = JSON.parse(e.postData.contents);
    console.log('🔍 파싱된 데이터:', data);
    
    // 데이터 유효성 검사
    if (!data.companyName || !data.email || !data.companySize || !data.businessType) {
      console.log('❌ 필수 정보 누락:', {
        companyName: !!data.companyName,
        email: !!data.email, 
        companySize: !!data.companySize,
        businessType: !!data.businessType
      });
      return ContentService
        .createTextOutput(JSON.stringify({
          success: false,
          message: '필수 정보가 누락되었습니다.'
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    console.log('🔗 스프레드시트 연결 시도:', SPREADSHEET_ID);
    
    // 스프레드시트에 데이터 저장
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getActiveSheet();
    console.log('✅ 스프레드시트 연결 성공, 시트명:', sheet.getName());
    
    const timestamp = new Date().toISOString();
    
    const rowData = [
      timestamp,
      data.companyName,
      data.companySize,
      data.businessType,
      data.email,
      data.overallScore || 0,
      data.maturityLevel || 1,
      data.identityScore || 0,
      data.deviceScore || 0,
      data.networkScore || 0,
      data.systemScore || 0,
      data.applicationScore || 0,
      data.dataScore || 0,
      JSON.stringify(data.allAnswers || {})
    ];
    
    console.log('📝 저장할 데이터:', rowData);
    
    // 새 행 추가
    sheet.appendRow(rowData);
    console.log('✅ 데이터 저장 완료');
    
    // 성공 응답
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        message: '데이터가 성공적으로 저장되었습니다.',
        timestamp: timestamp,
        rowsAdded: 1
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    // 에러 응답
    console.error('❌ 오류 발생:', error);
    console.error('오류 스택:', error.stack);
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        message: '서버 오류: ' + error.toString(),
        error: error.name || 'Unknown Error',
        stack: error.stack
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  // GET 요청 처리 (API 상태 확인용)
  const testData = {
    message: 'ESG 보안 진단 시스템 API가 정상 작동 중입니다.',
    timestamp: new Date().toISOString(),
    spreadsheetId: SPREADSHEET_ID.substring(0, 10) + '...', // ID 일부만 표시
    status: 'OK'
  };
  
  return ContentService
    .createTextOutput(JSON.stringify(testData))
    .setMimeType(ContentService.MimeType.JSON);
}

// 테스트 함수 (수동 실행용)
function testFunction() {
  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getActiveSheet();
    console.log('스프레드시트 연결 성공');
    console.log('시트 이름:', sheet.getName());
    return '테스트 성공';
  } catch (error) {
    console.error('테스트 실패:', error);
    return '테스트 실패: ' + error.toString();
  }
}
